# 基本概念
## 异常类型
1. 中断：FIQ（快速中断请求）和IRQ（普通中断请求） 
2. 中止：指令中止和数据中止，访问内存时发生错误（缺页等），由MMU捕获错误并报告给处理器。
3. 复位：优先级最高的一种异常处理，cpu的复位引脚产生复位信号，cpu进入复位状态，重新启动。
4. 系统调用：使用系统调用指令
## 异常等级
之前已经介绍过
## 同步与异步异常
1. 同步异常是处理器因执行某条指令触发的异常，常需要中断服务程序处理才能继续运行，如数据中止和指令中止。
2. 异步异常是异常触发的原因与当前处理器执行的指令无关的异常，例如中断。
# 异常处理
1. 异常发生时，cpu内核感知异常发生并确定异常等级，自动进行以下操作
  
  - 将PSTATE的值保存到对应目标等级的SPSR_ELx中
  - 将返回地址保存在ELR_ELx中
  - 将PSTATE寄存器中的D，A，I，F的标志位都设置为1
  - 对于同步异常，要将异常类型（原因）写入ESR_ELx
  - 切换SP寄存器为目标异常等级的SP_ELx或者SP_EL0寄存器
  - 切换到对应目标异常等级，然后跳转到异常向量表
  
  **ESR寄存器的26-31位是EC位域，表示发生异常的分类，0-14是ISS位域，异常指令编码信息，依赖于EC段。软件可通过读取EC得知异常的种类，再根据EC来解析ISS字段。ISS字段指明异常发生的具体原因P151**  
2. 根据操作系统设置好的异常向量表跳转到对应的异常处理程序
3. 异常返回：从ELR_ELx中获取返回地址，恢复PC指针，从SPSR_ELx中回复PSTATE值（此时，中断已开启）  
4. 返回地址： 
- 如果是异步异常，返回地址指向第一条还未执行或者由于中断没有成功执行的指令
- 如果是同步异常，返回的是触发异常的指令的地址
- 如果是系统调用，返回的是系统调用指令的下一条指令。
## 异常现场
在异常发生时需要在内核态的栈空间保护  
1. PSTATE的值
2. PC的值
3. SP的值
4. X0~X30寄存器的值
5. 详情P165